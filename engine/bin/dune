(library
 (name lib)
 (modules lib cli_types)
 (wrapped false)
 (libraries circus_engine
            fstar_backend coq_backend easycrypt_backend)
 (preprocess
  (pps
   ppx_yojson_conv
   ppx_deriving.show
   ppx_deriving.eq
   )))

(executable
 (public_name circus-engine)
 (name native_driver)
 (modules native_driver)
 (libraries lib))
 
(executable
 (optional)
 (name js_driver)
 (modes js)
 (modules js_driver)
 (js_of_ocaml
   (javascript_files
     js_stubs/mutex.js
     js_stubs/stdint.js
     js_stubs/unix.js
   )
 )
 (libraries zarith_stubs_js lib))

(rule
 (target cli_types.ml)
 (deps (:ocaml_of_json_schema ../utils/ocaml_of_json_schema/ocaml_of_json_schema.js))
 (action
  (with-stdout-to
   cli_types.ml
   (pipe-stdout
        (run cargo circus-export-json-schemas -- cli -)
        (run node %{ocaml_of_json_schema} - -)
   ))))

(env
 (dev
  (flags
   (:standard -warn-error -A))))
